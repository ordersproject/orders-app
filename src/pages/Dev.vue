<script lang="ts" setup>
import { onMounted } from 'vue'

// import { getUtxos, getTxHex } from '@/queries/proxy'
import { useBtcJsStore } from '@/stores'
// import * as bip39 from 'bip39'
import BIP32Factory from 'bip32'

const btcJsStore = useBtcJsStore()

onMounted(async () => {
  // gotta trigger deploy again
  const btcjs = window.bitcoin
  const secp256k1 = await import('tiny-secp256k1')
  btcjs.initEccLib(secp256k1)
  btcJsStore.set(btcjs)
})

function decodePsbt() {
  const raw =
    '70736274ff0100e8020000000300000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000000000000100000000ffffffff349c4f6bc87d9c142451754fd5a08ba65fdb1459cdf34cbb3bafcc537a75ffec0000000000ffffffff0300000000000000001976a914000000000000000000000000000000000000000088ac00000000000000001976a914000000000000000000000000000000000000000088aca086010000000000160014e0acb86393de998d6837c7f77725a285dbf60fb4000000000001011f0000000000000000160014ae47938f7acd1623e6e10e1ebcc33c2a7cb6e30d0001011f0000000000000000160014ae47938f7acd1623e6e10e1ebcc33c2a7cb6e30d0001011f2202000000000000160014e0acb86393de998d6837c7f77725a285dbf60fb40103048300000000000000'

  const btcjs = btcJsStore.get!

  const psbt = btcjs.Psbt.fromHex(raw)
  const psbtInput = psbt.data.inputs[0]
  console.log({ psbtInput })
  const input = psbt.txInputs[0]
  console.log(input.hash.toString('hex'))

  const outputScript = (psbt.data.globalMap.unsignedTx as any).tx.outs[0].script

  const my = new btcjs.Psbt()
  my.setVersion(2)
  my.addInput({
    hash: '0000000000000000000000000000000000000000000000000000000000000000',
    index: 0,
    witnessUtxo: psbt.data.inputs[0].witnessUtxo,
  })
    .addInput({
      hash: '0000000000000000000000000000000000000000000000000000000000000000',
      index: 1,
      witnessUtxo: psbt.data.inputs[1].witnessUtxo,
    })
    .addOutput({
      script: outputScript,
      value: 0,
    })
    .addOutput({
      script: outputScript,
      value: 0,
    })
  const myHex = my.toHex()
  const fin =
    '70736274ff0100a0020000000200000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000000000000100000000ffffffff0200000000000000001976a914000000000000000000000000000000000000000088ac00000000000000001976a914000000000000000000000000000000000000000088ac000000000001011f0000000000000000160014ae47938f7acd1623e6e10e1ebcc33c2a7cb6e30d0001011f0000000000000000160014ae47938f7acd1623e6e10e1ebcc33c2a7cb6e30d000000'
  const fin2 =
    '70736274ff0100a0020000000200000000000000000000000000000000000000000000000000000000000000000000000000ffffffff00000000000000000000000000000000000000000000000000000000000000000100000000ffffffff0200000000000000001976a914000000000000000000000000000000000000000088ac00000000000000001976a914000000000000000000000000000000000000000088ac000000000001011f0000000000000000160014ae47938f7acd1623e6e10e1ebcc33c2a7cb6e30d0001011f0000000000000000160014ae47938f7acd1623e6e10e1ebcc33c2a7cb6e30d000000'

  console.log({ input, psbt, my, myHex, equal: fin === fin2 })
}
</script>

<template>
  <div class="p-8">
    <button class="border p-2 rounded-md" @click="decodePsbt">
      decode psbt
    </button>
  </div>
</template>
